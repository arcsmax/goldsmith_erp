# Dependency Vulnerability Fix Plan
**Date**: 2025-11-15
**Priority**: HIGH (Security Critical)
**GitHub Alert**: 6 vulnerabilities (3 High, 3 Moderate)

---

## Executive Summary

GitHub Dependabot has detected **6 security vulnerabilities** in project dependencies. This plan outlines the systematic approach to identify, update, and verify fixes for all vulnerable packages.

**Alert URL**: https://github.com/arcsmax/goldsmith_erp/security/dependabot

---

## Strategy Overview

### Phase 1: Discovery (30 min)
1. Check backend dependencies (`pyproject.toml`, `poetry.lock`)
2. Check frontend dependencies (`package.json`, `yarn.lock`)
3. Run security audit tools
4. Identify exact vulnerable packages and versions

### Phase 2: Planning (15 min)
1. Research CVE details for each vulnerability
2. Determine safe upgrade path
3. Check for breaking changes in changelogs
4. Plan testing strategy

### Phase 3: Backend Updates (30-60 min)
1. Update Python dependencies
2. Regenerate `poetry.lock`
3. Run backend tests
4. Verify no breaking changes

### Phase 4: Frontend Updates (30-60 min)
1. Update Node.js dependencies
2. Regenerate `yarn.lock`
3. Run frontend tests
4. Verify no breaking changes

### Phase 5: Verification (30 min)
1. Run full application locally
2. Test critical user flows
3. Re-run security audits
4. Verify all vulnerabilities fixed

### Phase 6: Documentation & Commit (15 min)
1. Document all changes
2. Update CHANGELOG.md
3. Commit with detailed message
4. Push to remote

**Total Estimated Time**: 2.5 - 3.5 hours

---

## Tools & Commands

### Backend (Python/Poetry)

#### Check for Vulnerabilities
```bash
# Using pip-audit (recommended)
pip install pip-audit
pip-audit

# Using safety
pip install safety
safety check

# Poetry built-in check
poetry check
```

#### Update Dependencies
```bash
# Check outdated packages
poetry show --outdated

# Update specific package
poetry update <package-name>

# Update all packages (careful!)
poetry update

# Update and lock
poetry lock --no-update
```

### Frontend (Node.js/Yarn)

#### Check for Vulnerabilities
```bash
cd frontend

# Yarn audit
yarn audit

# npm audit (if using npm)
npm audit

# Check for outdated packages
yarn outdated
```

#### Update Dependencies
```bash
# Interactive update
yarn upgrade-interactive

# Update specific package
yarn upgrade <package-name>

# Update to latest (careful!)
yarn upgrade <package-name>@latest

# Fix vulnerabilities automatically
yarn audit fix
```

---

## Common Vulnerable Dependencies (to check)

### Python (Backend)

#### High Risk Packages:
1. **fastapi** - Check for CORS, SQLi vulnerabilities
2. **uvicorn** - HTTP parsing vulnerabilities
3. **sqlalchemy** - SQL injection patches
4. **pydantic** - Validation bypass issues
5. **cryptography** - Crypto weaknesses
6. **jose** (python-jose) - JWT vulnerabilities
7. **passlib** - Password hashing issues
8. **redis** - Command injection

#### Moderate Risk:
9. **requests** - SSRF, redirect issues
10. **urllib3** - HTTP parsing
11. **certifi** - Certificate validation

### Node.js (Frontend)

#### High Risk Packages:
1. **react** - XSS vulnerabilities
2. **react-dom** - XSS vulnerabilities
3. **axios** - SSRF, redirect issues
4. **vite** - Path traversal
5. **@types/node** - Type confusion
6. **typescript** - Compiler bugs

#### Moderate Risk:
7. **postcss** - ReDoS attacks
8. **@vitejs/plugin-react** - Build vulnerabilities
9. **eslint** - Code execution
10. **vitest** - Test runner issues

---

## Update Strategy

### Safe Update Approach

#### 1. Minor/Patch Updates (Low Risk)
```bash
# Update to latest patch version (1.2.3 → 1.2.4)
poetry update <package> --lock

# Safe for:
# - Bug fixes
# - Security patches
# - No breaking changes
```

#### 2. Minor Version Updates (Medium Risk)
```bash
# Update to latest minor version (1.2.3 → 1.3.0)
poetry add <package>@^1.3.0

# May include:
# - New features
# - Deprecation warnings
# - Minimal breaking changes
# - Requires testing
```

#### 3. Major Version Updates (High Risk)
```bash
# Update to new major version (1.2.3 → 2.0.0)
poetry add <package>@^2.0.0

# Likely includes:
# - Breaking changes
# - API changes
# - Requires code changes
# - Extensive testing needed
```

### Breaking Change Mitigation

#### Before Updating:
1. Read CHANGELOG.md of the package
2. Check GitHub releases for breaking changes
3. Search for migration guides
4. Review your code usage of the package

#### During Update:
1. Update one package at a time (for major versions)
2. Run tests after each update
3. Fix breaking changes immediately
4. Document changes

#### After Update:
1. Full test suite
2. Manual testing of affected features
3. Check for deprecation warnings
4. Update code if needed

---

## Testing Strategy

### Backend Testing

#### 1. Automated Tests
```bash
# Run pytest (if available)
pytest tests/ -v

# Run with coverage
pytest tests/ --cov=goldsmith_erp --cov-report=html
```

#### 2. Manual Testing
```bash
# Start backend
cd /home/user/goldsmith_erp
poetry run uvicorn goldsmith_erp.main:app --reload

# Test endpoints:
# - GET /health → Should return 200
# - POST /api/v1/login/access-token → Should authenticate
# - GET /api/v1/orders → Should return orders
# - WebSocket /ws/orders → Should connect
```

#### 3. Integration Testing
```bash
# Start full stack with Docker
make start

# Verify:
# - Database migrations run
# - Redis connection works
# - WebSocket connections work
# - API responses correct
```

### Frontend Testing

#### 1. Automated Tests
```bash
cd frontend

# Run Vitest tests
yarn test

# Run with coverage
yarn test:coverage

# Watch mode
yarn test:watch
```

#### 2. Build Testing
```bash
# Build for production
yarn build

# Verify no errors
# Check dist/ folder created
ls -la dist/
```

#### 3. Manual Testing
```bash
# Start dev server
yarn dev

# Test critical flows:
# 1. Login → Should work
# 2. View orders → Should load
# 3. Start time tracking → Should work
# 4. Scanner → Should function
# 5. WebSocket updates → Should receive
```

---

## Rollback Plan

If issues occur after updates:

### Backend Rollback
```bash
# Restore old poetry.lock
git checkout HEAD -- poetry.lock pyproject.toml

# Reinstall old versions
poetry install

# Verify works
poetry run uvicorn goldsmith_erp.main:app
```

### Frontend Rollback
```bash
# Restore old package.json
git checkout HEAD -- frontend/package.json frontend/yarn.lock

# Reinstall old versions
cd frontend
yarn install

# Verify works
yarn dev
```

### Full Rollback
```bash
# Revert all dependency changes
git checkout HEAD -- .

# Reinstall
poetry install
cd frontend && yarn install
```

---

## Expected Vulnerabilities (Hypothetical)

Based on common patterns, likely vulnerabilities:

### Python Dependencies

#### 1. cryptography < 41.0.0
**CVE**: CVE-2023-XXXXX
**Severity**: HIGH
**Issue**: Memory corruption in RSA decryption
**Fix**: Upgrade to >= 41.0.0
```bash
poetry add cryptography@^41.0.0
```

#### 2. fastapi < 0.104.0
**CVE**: CVE-2023-YYYYY
**Severity**: MODERATE
**Issue**: CORS bypass
**Fix**: Upgrade to >= 0.104.0
```bash
poetry add fastapi@^0.104.0
```

#### 3. urllib3 < 2.0.7
**CVE**: CVE-2023-ZZZZZ
**Severity**: HIGH
**Issue**: Cookie header injection
**Fix**: Upgrade to >= 2.0.7
```bash
poetry add urllib3@^2.0.7
```

### Node.js Dependencies

#### 4. vite < 5.0.0
**CVE**: CVE-2023-AAAAA
**Severity**: HIGH
**Issue**: Path traversal in dev server
**Fix**: Upgrade to >= 5.0.0
```bash
cd frontend
yarn upgrade vite@^5.0.0
```

#### 5. axios < 1.6.0
**CVE**: CVE-2023-BBBBB
**Severity**: MODERATE
**Issue**: SSRF via redirect
**Fix**: Upgrade to >= 1.6.0
```bash
yarn upgrade axios@^1.6.0
```

#### 6. postcss < 8.4.31
**CVE**: CVE-2023-CCCCC
**Severity**: MODERATE
**Issue**: ReDoS attack
**Fix**: Upgrade to >= 8.4.31
```bash
yarn upgrade postcss@^8.4.31
```

---

## Implementation Checklist

### Pre-Update
- [ ] Commit all current changes
- [ ] Create backup branch
- [ ] Document current versions
- [ ] Run existing tests (baseline)

### Backend Updates
- [ ] Run `pip-audit` or `safety check`
- [ ] Identify vulnerable packages
- [ ] Read changelogs for breaking changes
- [ ] Update packages one-by-one
- [ ] Run tests after each update
- [ ] Verify application starts
- [ ] Test API endpoints

### Frontend Updates
- [ ] Run `yarn audit`
- [ ] Identify vulnerable packages
- [ ] Read changelogs for breaking changes
- [ ] Update packages one-by-one
- [ ] Run tests after each update
- [ ] Verify build succeeds
- [ ] Test application manually

### Post-Update
- [ ] Re-run security audits (verify 0 vulnerabilities)
- [ ] Full application test (end-to-end)
- [ ] Update CHANGELOG.md
- [ ] Commit changes
- [ ] Push to remote
- [ ] Verify CI/CD passes

---

## Documentation Template

### CHANGELOG.md Entry
```markdown
## [Version] - 2025-11-15

### Security
- Fixed 6 dependency vulnerabilities (3 High, 3 Moderate)
- Updated cryptography from X.X.X to Y.Y.Y (CVE-2023-XXXXX)
- Updated fastapi from X.X.X to Y.Y.Y (CVE-2023-YYYYY)
- Updated urllib3 from X.X.X to Y.Y.Y (CVE-2023-ZZZZZ)
- Updated vite from X.X.X to Y.Y.Y (CVE-2023-AAAAA)
- Updated axios from X.X.X to Y.Y.Y (CVE-2023-BBBBB)
- Updated postcss from X.X.X to Y.Y.Y (CVE-2023-CCCCC)

### Changed
- Backend dependencies updated (see pyproject.toml)
- Frontend dependencies updated (see package.json)

### Testing
- All tests passing
- No breaking changes detected
- Application verified working
```

### Commit Message Template
```
security: fix 6 dependency vulnerabilities (3 High, 3 Moderate)

Resolved all GitHub Dependabot security alerts by updating vulnerable
dependencies to patched versions.

BACKEND (Python):
- cryptography: X.X.X → Y.Y.Y (CVE-2023-XXXXX) - HIGH
- fastapi: X.X.X → Y.Y.Y (CVE-2023-YYYYY) - MODERATE
- urllib3: X.X.X → Y.Y.Y (CVE-2023-ZZZZZ) - HIGH

FRONTEND (Node.js):
- vite: X.X.X → Y.Y.Y (CVE-2023-AAAAA) - HIGH
- axios: X.X.X → Y.Y.Y (CVE-2023-BBBBB) - MODERATE
- postcss: X.X.X → Y.Y.Y (CVE-2023-CCCCC) - MODERATE

VERIFICATION:
- All automated tests passing (130+ frontend, 0 backend)
- Manual testing completed
- Security audits show 0 vulnerabilities
- No breaking changes detected

TESTING:
- Backend: API endpoints verified
- Frontend: Build successful, all features working
- Integration: WebSocket, Redis, PostgreSQL all functional

Files Changed:
- pyproject.toml (backend dependencies)
- poetry.lock (regenerated)
- frontend/package.json (frontend dependencies)
- frontend/yarn.lock (regenerated)
- CHANGELOG.md (documented changes)
```

---

## Success Criteria

Fix is complete when:
- [ ] All 6 Dependabot alerts resolved
- [ ] Security audit shows 0 vulnerabilities
- [ ] All automated tests pass
- [ ] Manual testing confirms no regressions
- [ ] Application starts and runs correctly
- [ ] No console errors or warnings
- [ ] Changes documented in CHANGELOG.md
- [ ] Code committed and pushed

---

## Resources

### Security Audit Tools
- **pip-audit**: https://pypi.org/project/pip-audit/
- **safety**: https://pyup.io/safety/
- **Snyk**: https://snyk.io/
- **npm audit**: Built into npm
- **yarn audit**: Built into yarn

### Vulnerability Databases
- **CVE**: https://cve.mitre.org/
- **GitHub Advisory Database**: https://github.com/advisories
- **PyPI Advisory**: https://pypi.org/help/#security
- **npm Security Advisories**: https://www.npmjs.com/advisories

### Documentation
- **Poetry**: https://python-poetry.org/docs/
- **Yarn**: https://yarnpkg.com/
- **Dependabot**: https://docs.github.com/en/code-security/dependabot

---

**Status**: Ready for implementation
**Next Step**: Check actual vulnerabilities with security audit tools
